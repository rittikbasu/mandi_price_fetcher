# mandi price fetcher

a simple script to pull daily mandi prices from data.gov.in and drop them into supabase.

## why

- got tired of the govt api being flaky and not working for hours at a time
- wanted something i could cron and ignore
- needed it to pause, retry, and resume without me babysitting it

## what it does

- hits the govt open data api with a reused session and small backoff
- only runs for the current day’s data. before 9am ist it treats “today” as yesterday so you don’t crash on late uploads
- resumes from how many rows are already in supabase for that date

## setup

1. python 3.9+
2. create and activate a venv:
   ```bash
   python -m venv .venv
   source .venv/bin/activate
   ```
3. install deps:
   ```bash
   pip install -r requirements.txt
   ```
4. create the supabase table:

   ```sql
   create table public.mandi_prices (
     arrival_date date not null,
     state text null,
     district text null,
     market text null,
     commodity text null,
     variety text null,
     grade text null,
     min_price numeric null,
     max_price numeric null,
     modal_price numeric null,
     id bigint generated by default as identity primary key
   );

   alter table public.mandi_prices
     add constraint mandi_prices_unique
     unique (state, district, market, commodity, variety, grade, arrival_date);
   ```

5. `.env` in the repo root with:
   - `SUPABASE_URL`
   - `SUPABASE_API_KEY`
   - `SUPABASE_TABLE`

## run it

```bash
python main.py
```

drop it in cron if you like. logs go to `logs/cron.log`.

## notes

- source: https://www.data.gov.in/resource/current-daily-price-various-commodities-various-markets-mandi
- api key is the public demo key from data.gov.in
- dedupe is enforced in db to match the upsert key
- if the feed keeps lagging past 9am, change the rollover constant in `main.py`
